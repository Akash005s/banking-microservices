# ------------------------
# Common blocks
# ------------------------

x-service-defaults: &service-defaults
  mem_limit: 600m
  cpus: "0.5"
  restart: unless-stopped
  networks:
    - easybank
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

# Used only by CLIENT services
x-client-env: &client-env
  SPRING_PROFILES_ACTIVE: default
  SPRING_CONFIG_IMPORT: configserver:http://config-server:8071/
  EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8070/eureka/

# ------------------------
# Services
# ------------------------

services:

  # ------------------------
  # CONFIG SERVER
  # ------------------------
  config-server:
    image: docker.io/akash005s/config-server:1.2
    container_name: config-server
    <<: *service-defaults
    ports:
      - "8071:8071"
    environment:
      SPRING_PROFILES_ACTIVE: default
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8071/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ------------------------
  # EUREKA SERVER
  # ------------------------
  eureka-server:
    image: docker.io/akash005s/eureka-server:1.2
    container_name: eureka-server
    <<: *service-defaults
    ports:
      - "8070:8070"
    depends_on:
      config-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: default
      SPRING_CONFIG_IMPORT: configserver:http://config-server:8071/
      SPRING_APPLICATION_NAME: eurekaserver
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8070/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ------------------------
  # ACCOUNT SERVICE
  # ------------------------
  account-service:
    image: docker.io/akash005s/account-service:1.2
    container_name: account-service
    <<: *service-defaults
    ports:
      - "8081:8081"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      <<: *client-env
      SPRING_APPLICATION_NAME: accounts
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8081/actuator/health/readiness | grep UP || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ------------------------
  # LOAN SERVICE
  # ------------------------
  loan-service:
    image: docker.io/akash005s/loan-service:1.2
    container_name: loan-service
    <<: *service-defaults
    ports:
      - "8091:8091"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      <<: *client-env
      SPRING_APPLICATION_NAME: loans
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8091/actuator/health/readiness | grep UP || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ------------------------
  # CARD SERVICE
  # ------------------------
  card-service:
    image: docker.io/akash005s/card-service:1.2
    container_name: card-service
    <<: *service-defaults
    ports:
      - "9001:9001"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      <<: *client-env
      SPRING_APPLICATION_NAME: cards
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:9001/actuator/health/readiness | grep UP || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ------------------------
  # GATEWAY SERVICE
  # ------------------------
  gateway-service:
    image: docker.io/akash005s/gateway-server:1.2
    container_name: gateway-service
    <<: *service-defaults
    ports:
      - "8072:8072"
    depends_on:
      eureka-server:
        condition: service_healthy
      account-service:
        condition: service_healthy
      loan-service:
        condition: service_healthy
      card-service:
        condition: service_healthy
    environment:
      <<: *client-env
      SPRING_APPLICATION_NAME: gatewayserver

# ------------------------
# Network
# ------------------------

networks:
  easybank:
    driver: bridge
